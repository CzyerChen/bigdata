### HBase的功能组件
1）库函数 —– 连接到每一个客户端
 
2）一个master的主服务器 —– 管理元数据、region的管理、负载均衡、高可用、客户端相应
 
3）多个region server —–多个区组成，每个区会把表放到不同区进行管理

#### 主服务器Master
 负责管理回复HBase表的分区，维护region服务器列表、分配region、负载均衡

#### region服务器
- 主要负责存储和维护自己region,处理客户端的读写请求
- 其中需要说明的是，客户端在链接的时候都是直接连接到region ，来获取数据的存储位置信息，再读取数据，和master节点是没有什么关系的
- 客户端并不依赖master，他是通过zookeeper上保留的数据位置信息，去读取数据，在客户端只需要书写zookeeper的地址即可

#### 表和Region
- 表的特点是按照rowkey的字典序排列的，每一个表可能有多个region组成，每个region管理一部分数据，比如region1管理1-10的rowkey
- 表默认只有一个region ，通过列的不停分列产生多个region
- region的拆分操作非常快，比如当一个分区A需要分列成B+C，在异步分列这个操作还没完成之前，客户端的读写还在分区A上，当客户端读写完毕之后，才会读取新分区BC上面的数据，这保证了数据的稳定和客户端访问的稳定性，不阻塞
- 每个region默认100M -200M，每个region的最佳大小是根据服务器的处理能力来看的，建议1-2G
- 同一个region不会被拆分到不同region服务器，它没有副本，他会通过纠错码来恢复原有的数据
- 每个region服务器可以存储10-1000个region

#### Region定位
-客户端请求zookeeper ，zookeeper上面会存储一个mapper表，这个mapper表会存储region的相关源数据表信息–》regionInfo（开始的key，结束的key,名字和对应的服务器），然后客户端拿到链接信息后在，直接连接到对应的服务器即可
- 客户端为了加速寻址，可以缓存mapper表信息
- 寻址过程只需要链接zookeeper服务器，不需要链接master服务器

#### HBase系统架构
- 为什么能实现横向扩展，为什么能实现高可用
    - HBase将master注册到zookeeper， 可以通过多个master选举一个注册到zookeeper，这样即使一个master挂掉了，也可以用别的master
    - 横向扩展是因为，HBase底层使用了hadoop HDFS ，而hadoop自身就能够很灵活的进行横向扩展
```text

           |------ 客户端
           |          |
           |          |
           |         \|/
           |      Zookeeper <------Master
           |   |---------------------| |-----------|
          \|/ \|/                                 \|/
     |---------------------|       |------------------------|
     |Region server        |       | Region Server          |
HBase|Region Region Region |       | Region Region Region   |
     |---------------------|       |------------------------|
           |                              |
          \|/                            \|/
HDFS |---------------------|       |------------------------|
     |---------------------|       |------------------------|
          \|/                            \|/ 
HADOOP |---------------|           |------------------|
       |               |           |                  |
       |---------------|           |------------------|  
          
                
``` 

上面已经介绍了master节点的基本作用，以下在做总结主服务器master主要负责表和region的管理工作 
```text
1）管理用户对表的增删改查 
2）实现不同region之间的负载均衡 
3）在region分列和合并后，重新调整region的分布 
4）对发生故障上的region进行数据迁移

```

### Region服务器 
1） region服务器是hbase的核心模块，负责维护分配给自己的region， 并响应读写请求

#### region服务器的工作原理
```text
  |-----------------------------Region服务器集群----------------------------|
  |                                                                        |
  |  |-------------------------Region服务器------------------------------|  |
  |  |                                                                  |  |
  |  |  |---------------------Region服务器----------------------------|  |  |  
  |  |  |                                                            |  |  |
  |  |  | |-------------------Region服务器------------------------|   |  |  |
  |  |  | |         |--------------Region-----------------------||   |  |  | 
  |  |  | | |-----| |  |----------Region-----------------------|||   |  |  |
  |  |  | | |     | |  | |---------Region---------------------||||   |  |  |
  |  |  | | |     | |  | |  Store        Store       Store    ||||   |  |  |
  |  |  | | |HLog | |  | |StoreFile     StoreFile   StoreFile ||||   |  |  |
  |  |  | | |     | |  | |StoreFile     StoreFile   StoreFile ||||   |  |  |
  |  |  | | |     | |  | |StoreFile     StoreFile   StoreFile ||||   |  |  |
  |  |  | | |-----| |  | |------------------------------------||||   |  |  |
  |  |  | |         |  |---------------------------------------|||   |  |  |
  |  |  | |         |-------------------------------------------||   |  |  |
  |  |  | |------------------------------------------------------|   |  |  |
  |  |  |------------------------------------------------------------|  |  | 
  |  |------------------------------------------------------------------|  |
  |------------------------------------------------------------------------|   
``` 

1、用户读写数据的过程
- region服务器由若干个region和HLog组成
- 每个region服务器对应一个HLog
- HLog是hbase的前置日志，先写日志，再写入region,日志里面的记录作为备份和恢复的依据
- 用户数据首先被写入到MemoryStore和HLog中
- 只有当操作写入HLog之后，commit{}调用才会将其返回给客户端
- 当用户读取数据时，region服务器会首先访问Memstore缓存，如果找不到再去storeFile找，这样很多情况下可以减少数据IO
- region里面包括 mermeryStore和storeFile ,mermeryStore先将数据写入内存，等到一个阈值（可设置）再将所有数据刷新到磁盘上 

2、缓存的刷新
- 缓存刷新的阈值可以在配置文件中配置，类似64M ，并会在HLog中留下一个记录。要与自己的服务器性能对应，避免频繁GC和IO
- 每次刷写都会生成一个新的storeFile,因而每个store会包含很多storeFile，最后依靠master进行数据的合并
- 每个region都有自己的HLog，每次启动都会确认数据是否写入完毕，没有的话先依赖HLog进行数据的恢复，再将HLog删除

3、storeFile的合并
- 每次刷写都生成一个storeFile ，那么当store里面的storeFile过多，到一个阈值之后，进行手动或者自定的依赖master进行数据的合并
 
4、storeFile的数据组织 
- 算法——LSM树 
- 将数据的修改增量的保存在内存中，达到一定大小之后将这些操作修改批量写入磁盘

### store的工作原理
- store是region的核心
- 一个store是由很多个soreFile组成
- 单个soreFile太大的时候，又触发分列，将一个父region分裂成两个region

### HLog工作原理
- HLog保证HBase的保证系统恢复，它是一种预写式日志
- 用户更新数据必须首先写入日志，才能写入MemoryStore缓存，知道缓存内容对应的日志已经写入磁盘之后，缓存才会被刷写到磁盘

#### HLog的恢复策略
- zookeeper收到某一台region服务器故障之后，首先处理这台服务器上面的HLog
- 根据HLog的内容，将里面对于每一个region的数据进行整理，根据region对象进行拆分，本来1-10的属于region1 ，11-20属于region2,这样拆分好
- 然后将以上数据从HLog里面找一台可用的服务器，将两个region的数据先恢复出来
- 然后将恢复出来的两个region的数据重新分配到现有可用的region服务器上，并将HLog也一并合并过去
- 对于可用的region服务器接收到分配给自己的region对象和日志之后，它会根据对应的日志重新做一遍各种操作，将日志记录中的数据写入到memoryStore中，然后再刷新到storeFile，完成数据的恢复 